<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABC éŸ³æ¨‚è¨Šæ¯æ’­æ”¾å™¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background: #2c3e50; color: white; padding: 20px; }
        .container { background: #34495e; padding: 30px; border-radius: 15px; display: inline-block; }
        button { background: #27ae60; border: none; padding: 15px 40px; color: white; border-radius: 30px; font-size: 1.2rem; cursor: pointer; }
        .note-display { font-size: 2rem; margin: 20px 0; color: #f1c40f; min-height: 50px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸµ æƒæåˆ°çš„éŸ³æ¨‚è¨Šæ¯</h2>
    <div id="msg" style="font-size: 1.2rem; margin-bottom: 10px;"></div>
    <div class="note-display" id="noteDisplay">-</div>
    <button id="playBtn">æ’­æ”¾æ—‹å¾‹</button>
</div>

<script>
    // 1. å¾ç¶²å€å–å¾—åƒæ•¸ (å‡è¨­ç¶²å€ç‚º ?abc=CDE2FG&t=Hello)
    const params = new URLSearchParams(window.location.search);
    const abcMelody = params.get('abc') || "C D E F G A B c"; // é è¨­éŸ³éš
    const textMsg = params.get('t') || "æ­¡è¿ä½¿ç”¨éŸ³æ¨‚ QR Codeï¼";
    
    document.getElementById('msg').innerText = textMsg;

    // 2. ABC è½‰ Tone.js ç°¡æ˜“è§£æå¼•æ“
    function parseABC(abc) {
        const notes = [];
        const baseOctave = 4;
        
        // ç°¡å–®æ­£å‰‡ï¼šåŒ¹é… A-G æˆ– a-g åŠ ä¸Š é•·åº¦æ•¸å­—
        const regex = /([A-Ga-g])([\d\/]*)/g;
        let match;
        
        while ((match = regex.exec(abc)) !== null) {
            let char = match[1];
            let duration = match[2] || "1";
            
            // ABC è¦å‰‡ï¼šå¤§å¯«æ˜¯ç¬¬ 4 å…«åº¦ï¼Œå°å¯«æ˜¯ç¬¬ 5 å…«åº¦
            let octave = (char === char.toUpperCase()) ? baseOctave : baseOctave + 1;
            let noteName = char.toUpperCase() + octave;
            
            // è§£æé•·åº¦ (ç°¡åŒ–ç‰ˆï¼š1=4n, 2=2n)
            let toneDuration = duration === "2" ? "2n" : "4n";
            
            notes.push({ note: noteName, duration: toneDuration });
        }
        return notes;
    }

    // 3. æ’­æ”¾é‚è¼¯
    document.getElementById('playBtn').onclick = async () => {
        await Tone.start();
        const synth = new Tone.PolySynth(Tone.Synth).toDestination();
        const melody = parseABC(abcMelody);
        
        let time = Tone.now();
        melody.forEach(item => {
            Tone.Transport.scheduleOnce((t) => {
                document.getElementById('noteDisplay').innerText = item.note;
            }, time);
            
            synth.triggerAttackRelease(item.note, item.duration, time);
            time += Tone.Time(item.duration).toSeconds();
        });
        
        Tone.Transport.start();
    };
</script>
</body>
</html>
