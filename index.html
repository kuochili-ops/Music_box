<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³æ¨‚è¨Šæ¯ç›’å­ ğŸµ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 320px; text-align: center; }
        input, button { width: 100%; padding: 12px; margin-top: 10px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; }
        button { background: #6c5ce7; color: white; border: none; cursor: pointer; font-weight: bold; }
        #qrcode { margin-top: 20px; display: flex; justify-content: center; }
        #typing-text { font-size: 1.2rem; min-height: 1.5em; color: #444; margin-bottom: 20px; white-space: pre-wrap; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="generator-ui" class="card hidden">
        <h2>ğŸµ è£½ä½œéŸ³æ¨‚ QR Code</h2>
        <input type="text" id="userAbc" placeholder="ABC æ¨‚è­œä»£ç¢¼" value="^dz^d^cB2^czd2^czd2">
        <input type="text" id="userMsg" placeholder="æƒ³èªªçš„è©±...">
        <button onclick="generateQR()">ç”¢ç”Ÿå°ˆå±¬ QR Code</button>
        <div id="qrcode"></div>
    </div>

    <div id="player-ui" class="card hidden">
        <div id="typing-text"></div>
        <button id="playBtn" onclick="startExperience()">ğŸ¶ é–‹å•ŸéŸ³æ¨‚è¨Šæ¯</button>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);

        window.onload = () => {
            if (urlParams.has("abc")) {
                document.getElementById("player-ui").classList.remove("hidden");
            } else {
                document.getElementById("generator-ui").classList.remove("hidden");
            }
        };

        // 1. ç”¢ç”Ÿå™¨ï¼šå°‡è³‡è¨Šç·¨ç¢¼é€²ç¶²å€
        function generateQR() {
            const baseUrl = window.location.href.split('?')[0];
            const abc = document.getElementById("userAbc").value;
            const msg = document.getElementById("userMsg").value;

            // ä½¿ç”¨ encodeURIComponent ç¢ºä¿ç‰¹æ®Šå­—å…ƒï¼ˆå¦‚ä¸­æ–‡ï¼‰èƒ½æ­£ç¢ºå‚³é
            const finalUrl = `${baseUrl}?abc=${encodeURIComponent(abc)}&t=${encodeURIComponent(msg)}`;
            
            document.getElementById("qrcode").innerHTML = "";
            new QRCode(document.getElementById("qrcode"), {
                text: finalUrl,
                width: 180,
                height: 180
            });
        }

        // 2. æ’­æ”¾å™¨ï¼šè§£æç¶²å€ä¸¦å•Ÿå‹•
        async function startExperience() {
            await Tone.start();
            document.getElementById("playBtn").classList.add("hidden");
            
            const abc = decodeURIComponent(urlParams.get("abc"));
            const message = decodeURIComponent(urlParams.get("t") || "æ”¶åˆ°ä¸€å€‹è¨Šæ¯ï¼");

            typeWriter(message, 0);
            playRetroMusic(abc);
        }

        function typeWriter(text, i) {
            if (i < text.length) {
                document.getElementById("typing-text").innerHTML += text.charAt(i);
                setTimeout(() => typeWriter(text, i + 1), 150);
            }
        }

        function playRetroMusic(abc) {
            // è¨­å®šæ–¹æ³¢éŸ³è‰² (Square Wave)
            const synth = new Tone.Synth({
                oscillator: { type: "square" }
            }).toDestination();

            const notes = parseSimpleABC(abc);
            const now = Tone.now();

            notes.forEach(note => {
                synth.triggerAttackRelease(note.pitch, note.duration, now + note.time);
            });
        }

        // ç°¡æ˜“è§£æå™¨ï¼šè™•ç†åŸºæœ¬çš„ ABC ç¬¦è™Ÿ
        function parseSimpleABC(abc) {
            const notes = [];
            const pitchMap = { 'C': 'C4', 'D': 'D4', 'E': 'E4', 'F': 'F4', 'G': 'G4', 'A': 'A4', 'B': 'B4', 'c': 'C5', 'd': 'D5' };
            let time = 0;

            for (let i = 0; i < abc.length; i++) {
                let char = abc[i];
                let pitch = "";
                if (char === '^') { pitch = pitchMap[abc[++i]]?.replace('4', '#4').replace('5', '#5'); }
                else if (pitchMap[char]) { pitch = pitchMap[char]; }
                
                if (pitch || char === 'z') {
                    let dur = 1;
                    if (!isNaN(abc[i+1])) dur = parseInt(abc[++i]);
                    if (pitch) notes.push({ time: time * 0.2, pitch: pitch, duration: dur * 0.15 });
                    time += dur;
                }
            }
            return notes;
        }
    </script>
</body>
</html>
