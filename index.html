<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³æ¨‚è¨Šæ¯ QR ç”¢ç”Ÿå™¨ ğŸµ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; padding: 20px; display: flex; justify-content: center; }
        .container { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 500px; }
        h2 { color: #333; margin-top: 0; border-left: 5px solid #6c5ce7; padding-left: 10px; }
        
        /* è¼¸å…¥å€åŸŸæ¨£å¼ */
        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        textarea { font-family: monospace; resize: vertical; }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-group { display: flex; gap: 10px; }
        button { flex: 1; padding: 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.3s; }
        .btn-generate { background: #6c5ce7; color: white; }
        .btn-preview { background: #00b894; color: white; }
        button:hover { opacity: 0.9; transform: translateY(-2px); }

        /* é è¦½èˆ‡ QR Code å€åŸŸ */
        .result-section { margin-top: 30px; padding-top: 20px; border-top: 2px dashed #eee; text-align: center; }
        #qrcode { display: inline-block; margin: 20px 0; padding: 10px; background: white; border: 1px solid #eee; }
        #typing-display { font-size: 1.2rem; min-height: 1.5em; color: #2d3436; margin: 20px 0; font-weight: 500; }
        
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h2>1. ç·¨è¼¯å…§å®¹ âœï¸</h2>
    <div class="input-group">
        <label>è¨Šæ¯æ–‡å­—ï¼š</label>
        <input type="text" id="userMsg" placeholder="è¼¸å…¥ä½ æƒ³èªªçš„è©±...">
    </div>
    
    <div class="input-group">
        <label>ABC æ¨‚è­œä»£ç¢¼ï¼š</label>
        <textarea id="userAbc" rows="6" placeholder="è²¼ä¸Š ABC ä»£ç¢¼..."></textarea>
    </div>

    <div class="btn-group">
        <button class="btn-generate" onclick="generateAndShow()">ç”Ÿæˆ QR Code ğŸ“²</button>
        <button class="btn-preview" onclick="previewCard()">é è¦½å¡ç‰‡ ğŸ‘ï¸</button>
    </div>

    <div id="result-area" class="result-section hidden">
        <h2>2. é è¦½çµæœ ğŸ</h2>
        <div id="typing-display"></div>
        <div id="qrcode"></div>
        <p style="font-size: 0.8rem; color: #999;">æƒæä¸Šæ–¹ QR Code å³å¯å‚³é€å¡ç‰‡</p>
    </div>
</div>

<script>
    // é å¡«ä½ æä¾›çš„é‚£æ®µè½‰æ›å¾Œçš„ ABC ä»£ç¢¼
    const defaultABC = "X:1\nM:4/4\nL:1/16\nQ:113\nK:C\n^d z ^d ^c B2 ^c z d2 ^c z d2 | z2 z2 ^c2 ^f z ^f2 ^A, z G,4";
    document.getElementById('userAbc').value = defaultABC;
    document.getElementById('userMsg').value = "é€™æ˜¯ä¸€æ®µå°ˆå±¬ä½ çš„éŸ³æ¨‚è¨Šæ¯ï¼";

    // ç”Ÿæˆ QR Code ä¸¦é¡¯ç¤ºçµæœå€åŸŸ
    function generateAndShow() {
        const msg = document.getElementById('userMsg').value;
        const abc = document.getElementById('userAbc').value;
        const baseUrl = window.location.href.split('?')[0];
        
        // å°è£æˆç¶²å€
        const finalUrl = `${baseUrl}?t=${encodeURIComponent(msg)}&abc=${encodeURIComponent(abc)}`;
        
        // é¡¯ç¤ºçµæœå€åŸŸ
        document.getElementById('result-area').classList.remove('hidden');
        
        // æ¸…é™¤èˆŠçš„ QR Code
        document.getElementById('qrcode').innerHTML = "";
        new QRCode(document.getElementById('qrcode'), {
            text: finalUrl,
            width: 180,
            height: 180
        });
        
        window.scrollTo(0, document.body.scrollHeight);
    }

    // æœ¬åœ°é è¦½åŠŸèƒ½
    async function previewCard() {
        await Tone.start();
        const msg = document.getElementById('userMsg').value;
        const abc = document.getElementById('userAbc').value;
        
        document.getElementById('result-area').classList.remove('hidden');
        document.getElementById('typing-display').innerText = "";
        
        // 1. å•Ÿå‹•æ‰“å­—æ©Ÿ
        typeWriter(msg);
        
        // 2. æ’­æ”¾éŸ³æ¨‚ (ä½¿ç”¨æ–¹æ³¢)
        playMusic(abc);
    }

    function typeWriter(text) {
        let i = 0;
        const display = document.getElementById('typing-display');
        const timer = setInterval(() => {
            display.innerText += text[i];
            i++;
            if (i >= text.length) clearInterval(timer);
        }, 100);
    }

    function playMusic(abc) {
        const synth = new Tone.Synth({ oscillator: { type: "square" } }).toDestination();
        const now = Tone.now();
        
        // ç°¡æ˜“è§£æéŸ³ç¬¦ (æŠ“å–å¤§å¯« A-G èˆ‡ ^ å‡è™Ÿ)
        const notes = abc.match(/\^?[A-Ga-g]/g) || [];
        notes.forEach((n, i) => {
            // è½‰æ› ABC æ ¼å¼ç‚º Tone.js æ ¼å¼
            let toneNote = n.replace('^', '#') + "4"; 
            synth.triggerAttackRelease(toneNote, "16n", now + i * 0.15);
        });
    }

    // å¦‚æœæ˜¯æƒæ QR Code é€²ä¾†çš„ï¼Œç›´æ¥é€²å…¥æ’­æ”¾æ¨¡å¼
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('abc')) {
        document.querySelector('h2').innerText = "æ”¶åˆ°éŸ³æ¨‚è¨Šæ¯ï¼";
        document.querySelector('.input-group:nth-child(2)').style.display = 'none';
        document.querySelector('.input-group:nth-child(3)').style.display = 'none';
        document.querySelector('.btn-group').innerHTML = '<button class="btn-preview" onclick="previewCard()">ğŸ¶ é–‹å•Ÿè¨Šæ¯</button>';
    }
</script>

</body>
</html>
