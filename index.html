<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³æ¨‚è¨Šæ¯ç”¢ç”Ÿå™¨ Pro ğŸ¹</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://unpkg.com/@tonejs/midi"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --primary: #6c5ce7; --secondary: #00b894; --bg: #f8f9fa; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; }
        .container { background: white; padding: 25px; border-radius: 24px; box-shadow: 0 12px 40px rgba(0,0,0,0.12); width: 100%; max-width: 500px; }
        .section { border-bottom: 2px solid #f1f2f6; margin-bottom: 20px; padding-bottom: 20px; }
        h2 { font-size: 1.25rem; color: #2d3436; margin-top: 0; display: flex; align-items: center; gap: 8px; }
        label { display: block; margin: 15px 0 8px; font-weight: bold; color: #636e72; font-size: 0.9rem; }
        input, textarea, select { width: 100%; padding: 12px; border: 1px solid #dfe6e9; border-radius: 12px; box-sizing: border-box; font-size: 15px; background: #fff; }
        textarea { font-family: 'Consolas', 'Monaco', monospace; height: 120px; line-height: 1.5; }
        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        button { flex: 1; padding: 14px; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; font-size: 16px; transition: all 0.2s; }
        .btn-midi { background: #ff7675; color: white; }
        .btn-pre { background: var(--secondary); color: white; }
        .btn-gen { background: var(--primary); color: white; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        button:active { transform: translateY(0); }
        #track-selector { display: none; background: #f9f9fb; padding: 15px; border-radius: 14px; margin-top: 10px; border: 1px solid #eee; }
        #result-area { margin-top: 25px; text-align: center; display: none; }
        #typing-text { font-size: 1.4rem; margin: 20px 0; font-weight: 700; color: #2d3436; min-height: 1.6em; word-break: break-all; }
        #qrcode-container { display: inline-block; padding: 10px; background: white; border-radius: 10px; border: 1px solid #eee; }
        .hint { font-size: 0.8rem; color: #95a5a6; margin-top: 5px; }
    </style>
</head>
<body>

<div class="container">
    <div class="section">
        <h2>ğŸ¹ MIDI è½‰ ABC å·¥å…·</h2>
        <label>ä¸Šå‚³ MIDI æª”æ¡ˆï¼š</label>
        <input type="file" id="midiInput" accept=".mid,.midi" onchange="handleMidiUpload()">
        
        <div id="track-selector">
            <label>é¸æ“‡ä¸»æ—‹å¾‹è»Œé“ï¼š</label>
            <select id="midiTracks"></select>
            <div class="hint">â€» å·²å„ªåŒ–å…«åº¦è§£æä¸¦éæ¿¾èƒŒæ™¯èœ‚é³´éŸ³</div>
            <div class="btn-group">
                <button class="btn-midi" onclick="playMidiPreview()">ğŸ‘‚ è©¦è½è»Œé“</button>
                <button class="btn-gen" onclick="convertToAbc()">âœ… è½‰ç‚º ABC</button>
            </div>
        </div>
    </div>

    <div class="section">
        <label>ğŸ’Œ ç•™è¨€å…§å®¹ï¼š</label>
        <input type="text" id="userMsg" value="é€™æ˜¯ä¸€æ®µå®Œç¾çš„æ—‹å¾‹ï¼">
        
        <label>ğŸ¼ ABC æ¨‚è­œä»£ç¢¼ï¼š</label>
        <textarea id="userAbc" placeholder="æ‰‹å¯«æˆ–ç”± MIDI è½‰æ›..."></textarea>
        
        <div class="btn-group">
            <button class="btn-pre" onclick="startPreviewLoop()">ğŸ‘ï¸ é è¦½å¾ªç’°æ’­æ”¾</button>
            <button class="btn-gen" onclick="generateQR()">ğŸ“² ç”Ÿæˆ QR</button>
        </div>
    </div>

    <div id="result-area">
        <div id="typing-text"></div>
        <div id="qrcode-container"></div>
    </div>
</div>

<script>
    let currentMidi = null;
    let previewSynth = null;
    let typingTimer = null;
    let transportLoop = null;

    // --- MIDI è™•ç† ---
    async function handleMidiUpload() {
        const file = document.getElementById('midiInput').files[0];
        if (!file) return;
        const arrayBuffer = await file.arrayBuffer();
        currentMidi = new Midi(arrayBuffer);

        const select = document.getElementById('midiTracks');
        select.innerHTML = "";
        currentMidi.tracks.forEach((track, index) => {
            if (track.notes.length > 0) {
                const option = document.createElement('option');
                option.value = index;
                option.text = `è»Œé“ ${index + 1}: ${track.name || 'Instrument'} (${track.notes.length} éŸ³ç¬¦)`;
                select.appendChild(option);
            }
        });
        document.getElementById('track-selector').style.display = 'block';
    }

    async function playMidiPreview() {
        await Tone.start();
        if (previewSynth) previewSynth.dispose();
        previewSynth = new Tone.PolySynth(Tone.Synth).toDestination();
        const track = currentMidi.tracks[document.getElementById('midiTracks').value];
        const now = Tone.now();
        // è©¦è½å‰ 10 ç§’
        track.notes.forEach(n => {
            if (n.time < 10) previewSynth.triggerAttackRelease(n.name, n.duration, now + n.time, n.velocity);
        });
    }

    function convertToAbc() {
        const track = currentMidi.tracks[document.getElementById('midiTracks').value];
        let abc = "X:1\nM:4/4\nL:1/16\nQ:120\nK:C\n";
        let lastEndTime = 0;

        // æ ¸å¿ƒå»é›œè¨Šèˆ‡ç²¾ç¢ºå…«åº¦åˆ¤å®š
        const cleanNotes = track.notes.filter(n => n.duration > 0.05);

        cleanNotes.forEach(note => {
            const startTime = note.time;
            const waitTime = startTime - lastEndTime;
            
            // è™•ç†ä¼‘æ­¢ç¬¦
            if (waitTime > 0.05) {
                let zCount = Math.round(waitTime * 8); 
                if (zCount > 0) abc += "z" + (zCount > 1 ? zCount : "") + " ";
            }

            let noteBase = note.pitch.replace(/[0-9#b]/g, '');
            let isSharp = note.pitch.includes('#');
            let octave = note.octave;
            let finalNote = isSharp ? "^" : "";

            // ABC å…«åº¦èªæ³•ä¿®æ­£
            if (octave === 4) {
                finalNote += noteBase.toUpperCase();
            } else if (octave === 5) {
                finalNote += noteBase.toLowerCase();
            } else if (octave < 4) {
                let commas = ",".repeat(4 - octave);
                finalNote += noteBase.toUpperCase() + commas;
            } else {
                let apostrophes = "'".repeat(octave - 5);
                finalNote += noteBase.toLowerCase() + apostrophes;
            }

            let durCount = Math.round(note.duration * 8);
            abc += finalNote + (durCount > 1 ? durCount : "") + " ";
            lastEndTime = startTime + note.duration;
        });

        document.getElementById('userAbc').value = abc.trim();
        alert("éŸ³éšç²¾æº–è½‰æ›å®Œæˆï¼å·²å¡«å…¥ä¸‹æ–¹ç·¨è¼¯æ¡†ã€‚");
    }

    // --- æ’­æ”¾èˆ‡é‡è¤‡é‚è¼¯ ---
    async function startPreviewLoop() {
        await Tone.start();
        Tone.Transport.stop();
        Tone.Transport.cancel();
        if (typingTimer) clearInterval(typingTimer);
        
        document.getElementById('result-area').style.display = 'block';
        const msg = document.getElementById('userMsg').value;
        const abc = document.getElementById('userAbc').value;

        // ä½¿ç”¨ 8-bit æ–¹æ³¢éŸ³è‰²
        const synth = new Tone.Synth({ 
            oscillator: { type: "square" },
            envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 0.8 }
        }).toDestination();

        // è§£æ ABC (æ”¯æ´ 1/16 ç‚ºåº•çš„æ ¼å¼)
        const tokens = abc.match(/([\^z]?[A-Ga-g][,']*[\d\/]*|z[\d\/]*)/g) || [];
        let totalTicks = 0;
        const tickTime = 0.125; // æ¯ä¸€å€‹ L:1/16 çš„æ™‚é•· (ç§’)

        const melody = tokens.map(token => {
            const isRest = token.startsWith('z');
            const pitchPart = token.match(/[\^]?[A-Ga-g][,']*/);
            const durMatch = token.match(/\d+/);
            const duration = durMatch ? parseInt(durMatch[0]) : 1;
            
            const noteData = {
                time: totalTicks * tickTime,
                pitch: (!isRest && pitchPart) ? pitchPart[0] : null,
                dur: (duration * tickTime * 0.9) + "s",
                step: duration
            };
            totalTicks += duration;
            return noteData;
        });

        // å»ºç«‹é‡è¤‡æ’­æ”¾ç’°
        const loopInterval = totalTicks * tickTime;
        
        Tone.Transport.scheduleRepeat((time) => {
            // éŸ³æ¨‚éƒ¨åˆ†
            melody.forEach(n => {
                if (n.pitch) {
                    // ABC èªæ³•è½‰ Tone.js éŸ³é«˜ (ç²—ç•¥è™•ç†ï¼Œåƒ…ä¾›é è¦½)
                    let p = n.pitch.replace('^', '#');
                    let finalP = p.toUpperCase() + (p === p.toLowerCase() ? "5" : "4");
                    synth.triggerAttackRelease(finalP, n.dur, time + n.time);
                }
            });

            // æ‰“å­—æ©Ÿé‡ç½®åŒæ­¥
            Tone.Draw.schedule(() => {
                resetTypewriter(msg);
            }, time);
        }, loopInterval);

        Tone.Transport.start();
    }

    function resetTypewriter(text) {
        if (typingTimer) clearInterval(typingTimer);
        const el = document.getElementById('typing-text');
        el.innerText = "";
        let i = 0;
        typingTimer = setInterval(() => {
            el.innerText += text[i];
            i++;
            if (i >= text.length) clearInterval(typingTimer);
        }, 120);
    }

    function generateQR() {
        const msg = document.getElementById('userMsg').value;
        const abc = document.getElementById('userAbc').value;
        const finalUrl = `${window.location.origin}${window.location.pathname}?t=${encodeURIComponent(msg)}&abc=${encodeURIComponent(abc)}`;
        
        const container = document.getElementById('qrcode-container');
        container.innerHTML = "";
        new QRCode(container, { text: finalUrl, width: 200, height: 200 });
        document.getElementById('result-area').style.display = 'block';
        alert("QR Code å·²ç”Ÿæˆï¼");
    }

    // è‡ªå‹•åµæ¸¬ URL åƒæ•¸ (ä¾›æ”¶ä»¶è€…ä½¿ç”¨)
    const params = new URLSearchParams(window.location.search);
    if (params.has('abc')) {
        document.getElementById('userMsg').value = decodeURIComponent(params.get('t'));
        document.getElementById('userAbc').value = decodeURIComponent(params.get('abc'));
    }
</script>

</body>
</html>
