<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³æ¨‚è¨Šæ¯ç”¢ç”Ÿå™¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; display: flex; justify-content: center; padding: 20px; }
        .container { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); width: 100%; max-width: 450px; }
        .input-section { border-bottom: 2px solid #eee; margin-bottom: 20px; padding-bottom: 20px; }
        label { display: block; margin: 10px 0 5px; font-weight: bold; color: #444; }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; margin-bottom: 10px; }
        textarea { font-family: monospace; height: 100px; }
        .btn-group { display: flex; gap: 10px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; }
        .btn-pre { background: #00b894; color: white; }
        .btn-gen { background: #6c5ce7; color: white; }
        #result-ui { text-align: center; }
        #typing-text { font-size: 1.2rem; margin: 20px 0; color: #333; min-height: 1.5em; border-bottom: 1px dashed #ccc; padding-bottom: 10px; }
        #qrcode-container { display: flex; justify-content: center; margin: 15px 0; }
    </style>
</head>
<body>

<div class="container">
    <div class="input-section" id="editor-ui">
        <h2>ğŸµ è£½ä½œéŸ³æ¨‚è¨Šæ¯</h2>
        <label>ğŸ’¬ ç•™è¨€å…§å®¹ï¼š</label>
        <input type="text" id="userMsg" placeholder="è¼¸å…¥ç•™è¨€...">
        
        <label>ğŸ¼ ABC æ¨‚è­œä»£ç¢¼ï¼š</label>
        <textarea id="userAbc" placeholder="è²¼ä¸Š ABC ä»£ç¢¼..."></textarea>
        
        <div class="btn-group">
            <button class="btn-pre" onclick="preview()">ğŸ‘ï¸ é è¦½æ’­æ”¾</button>
            <button class="btn-gen" onclick="generateQR()">ğŸ“² ç”Ÿæˆ QR</button>
        </div>
    </div>

    <div id="result-ui">
        <div id="typing-text"></div>
        <div id="qrcode-container"></div>
    </div>
</div>

<script>
    // åˆå§‹åŒ–é è¨­å€¼
    const defaultABC = "X:1\nM:4/4\nL:1/16\nQ:113\nK:C\n^d z ^d ^c B2 ^c z d2 ^c z d2 | z2 z2 ^c2 ^f z ^f2 ^A, z G,4";
    document.getElementById('userAbc').value = defaultABC;
    document.getElementById('userMsg').value = "é€™æ˜¯ä¸€å°éŸ³æ¨‚æƒ…æ›¸ï¼";

    async function preview() {
        await Tone.start();
        const msg = document.getElementById('userMsg').value;
        const abc = document.getElementById('userAbc').value;
        document.getElementById('typing-text').innerText = "";
        startExperience(msg, abc);
    }

    function generateQR() {
        const msg = document.getElementById('userMsg').value;
        const abc = document.getElementById('userAbc').value;
        const finalUrl = `${window.location.origin}${window.location.pathname}?t=${encodeURIComponent(msg)}&abc=${encodeURIComponent(abc)}`;
        
        const container = document.getElementById('qrcode-container');
        container.innerHTML = "";
        new QRCode(container, { text: finalUrl, width: 180, height: 180 });
        alert("QR Code ç”ŸæˆæˆåŠŸï¼");
    }

    function startExperience(msg, abc) {
        // æ‰“å­—æ©Ÿ
        let i = 0;
        const timer = setInterval(() => {
            document.getElementById('typing-text').innerText += msg[i];
            i++;
            if (i >= msg.length) clearInterval(timer);
        }, 120);

        // éŸ³æ¨‚æ’­æ”¾ (æ–¹æ³¢)
        const synth = new Tone.Synth({ oscillator: { type: "square" } }).toDestination();
        const now = Tone.now();
        const notes = abc.match(/\^?[A-Ga-g]/g) || [];
        notes.forEach((n, idx) => {
            let toneNote = n.replace('^', '#') + "4";
            synth.triggerAttackRelease(toneNote, "16n", now + idx * 0.15);
        });
    }

    // è‡ªå‹•è®€å– URL åƒæ•¸
    const params = new URLSearchParams(window.location.search);
    if (params.has('abc')) {
        // å¦‚æœæƒ³åœ¨æ”¶è¨Šæ™‚å¾¹åº•éš±è—ç·¨è¼¯å™¨ï¼Œå¯ä»¥ä¿ç•™ä¸‹é¢é€™è¡Œï¼š
        // document.getElementById('editor-ui').style.display = 'none'; 
        document.getElementById('userMsg').value = decodeURIComponent(params.get('t'));
        document.getElementById('userAbc').value = decodeURIComponent(params.get('abc'));
    }
</script>

</body>
</html>
