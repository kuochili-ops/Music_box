<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³æ¨‚è¨Šæ¯ç”¢ç”Ÿå™¨ ğŸµ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; padding: 20px; display: flex; justify-content: center; }
        .container { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 450px; }
        h2 { display: flex; align-items: center; gap: 10px; color: #333; margin-top: 0; }
        label { display: block; margin: 15px 0 8px; font-weight: bold; color: #555; }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 16px; background: #fafafa; }
        textarea { font-family: 'Consolas', monospace; height: 120px; }
        .btn-group { display: flex; gap: 12px; margin-top: 20px; }
        button { flex: 1; padding: 14px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.2s; }
        .btn-pre { background: #55efc4; color: #004d40; }
        .btn-gen { background: #6c5ce7; color: white; }
        button:active { transform: scale(0.98); }
        #result-area { margin-top: 25px; padding-top: 20px; border-top: 2px dashed #eee; text-align: center; }
        #typing-text { font-size: 1.3rem; margin: 20px 0; color: #2d3436; font-weight: 600; min-height: 1.5em; }
        #qrcode-container { display: inline-block; padding: 10px; background: white; border: 1px solid #eee; }
    </style>
</head>
<body>

<div class="container">
    <div id="editor-ui">
        <h2>ğŸµ è£½ä½œéŸ³æ¨‚è¨Šæ¯</h2>
        <label>ğŸ’¬ ç•™è¨€å…§å®¹ï¼š</label>
        <input type="text" id="userMsg" value="é€™æ˜¯ä¸€å°æœƒé‡è¤‡æ’­æ”¾çš„éŸ³æ¨‚æƒ…æ›¸ï¼">
        
        <label>ğŸ¼ ABC æ¨‚è­œä»£ç¢¼ï¼š</label>
        <textarea id="userAbc">X:1
M:4/4
L:1/16
Q:113
K:C
^d z ^d ^c B2 ^c z d2 ^c z d2 | z2 z2 ^c2 ^f z ^f2 ^A, z G,4</textarea>
        
        <div class="btn-group">
            <button class="btn-pre" onclick="preview()">ğŸ‘ï¸ é è¦½æ’­æ”¾ (ç„¡é™å¾ªç’°)</button>
            <button class="btn-gen" onclick="generateQR()">ğŸ“² ç”Ÿæˆ QR</button>
        </div>
    </div>

    <div id="result-area">
        <div id="typing-text"></div>
        <div id="qrcode-container"></div>
    </div>
</div>

<script>
    let typingTimer = null;
    let mainLoop = null;

    async function preview() {
        await Tone.start();
        
        // å¾¹åº•åœæ­¢ä¸¦æ¸…é™¤èˆŠçš„æ’­æ”¾
        Tone.Transport.stop();
        Tone.Transport.cancel();
        if (mainLoop) {
            mainLoop.dispose();
            mainLoop = null;
        }
        if (typingTimer) clearInterval(typingTimer);
        
        document.getElementById('result-area').style.display = 'block';
        document.getElementById('typing-text').innerText = "";
        
        const msg = document.getElementById('userMsg').value;
        const abc = document.getElementById('userAbc').value;

        // 1. åˆå§‹åŒ–åˆæˆå™¨
        const synth = new Tone.Synth({ 
            oscillator: { type: "square" },
            envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 }
        }).toDestination();

        // 2. è§£ææ¨‚è­œä¸¦è¨ˆç®—ç¸½é•·åº¦
        const tokens = abc.match(/(\^?[A-Ga-g],?\d*|z\d*)/g) || [];
        const bpmFactor = 0.133; // 113BPM ä¸‹ 16åˆ†éŸ³ç¬¦ç´„ 0.133s
        let totalDuration = 0;
        const melodyData = tokens.map(token => {
            const isRest = token.startsWith('z');
            const hasSharp = token.includes('^');
            const hasLowerOctave = token.includes(',');
            const noteName = token.match(/[A-Ga-g]/)?.[0];
            const durationMatch = token.match(/\d+/);
            const duration = durationMatch ? parseInt(durationMatch[0]) : 1;
            
            const item = {
                time: totalDuration * bpmFactor,
                pitch: !isRest && noteName ? (noteName.toUpperCase() + (hasSharp ? "#" : "") + (noteName === noteName.toLowerCase() ? 5 : (hasLowerOctave ? 3 : 4))) : null,
                duration: (duration * 0.12) + "s",
                step: duration
            };
            totalDuration += duration;
            return item;
        });

        // 3. å»ºç«‹å¾ªç’°æ’­æ”¾ (Loop)
        // å¢åŠ  2 å€‹ step çš„é¤˜è£•æ™‚é–“ï¼Œè®“å¾ªç’°è½èµ·ä¾†æ›´é †
        const loopInterval = (totalDuration + 2) * bpmFactor;

        mainLoop = new Tone.Loop((time) => {
            // åœ¨å¾ªç’°èµ·é»é‡ç½®æ‰“å­—æ©Ÿ
            Tone.Draw.schedule(() => {
                document.getElementById('typing-text').innerText = "";
                startTypewriter(msg);
            }, time);

            // æ’­æ”¾æ•´æ®µæ—‹å¾‹
            melodyData.forEach(item => {
                if (item.pitch) {
                    synth.triggerAttackRelease(item.pitch, item.duration, time + item.time);
                }
            });
        }, loopInterval).start(0);

        Tone.Transport.start();
    }

    function startTypewriter(text) {
        if (typingTimer) clearInterval(typingTimer);
        let i = 0;
        const display = document.getElementById('typing-text');
        typingTimer = setInterval(() => {
            display.innerText += text[i];
            i++;
            if (i >= text.length) clearInterval(typingTimer);
        }, 100);
    }

    function generateQR() {
        const msg = document.getElementById('userMsg').value;
        const abc = document.getElementById('userAbc').value;
        const finalUrl = `${window.location.origin}${window.location.pathname}?t=${encodeURIComponent(msg)}&abc=${encodeURIComponent(abc)}`;
        
        const container = document.getElementById('qrcode-container');
        container.innerHTML = "";
        new QRCode(container, { text: finalUrl, width: 180, height: 180 });
    }

    // è™•ç† URL åƒæ•¸ (æƒæé€²ä¾†çš„æƒ…å¢ƒ)
    const params = new URLSearchParams(window.location.search);
    if (params.has('abc')) {
        document.getElementById('userMsg').value = decodeURIComponent(params.get('t'));
        document.getElementById('userAbc').value = decodeURIComponent(params.get('abc'));
    }
</script>

</body>
</html>
