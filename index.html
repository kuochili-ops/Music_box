<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³æ¨‚è¨Šæ¯ QR Code ç”¢ç”Ÿå™¨ ğŸµ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --primary: #6c5ce7; --secondary: #00b894; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; }
        .container { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 450px; }
        
        h2 { color: #2d3436; margin-bottom: 20px; text-align: center; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #636e72; }
        
        /* è¼¸å…¥æ¬„ä½æ¨£å¼ */
        input[type="text"], textarea {
            width: 100%; padding: 12px; margin-bottom: 20px;
            border: 2px solid #dfe6e9; border-radius: 10px;
            box-sizing: border-box; font-size: 16px; transition: border-color 0.3s;
        }
        input:focus, textarea:focus { border-color: var(--primary); outline: none; }
        textarea { font-family: 'Consolas', monospace; resize: vertical; min-height: 120px; }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        button {
            padding: 15px; border: none; border-radius: 10px;
            font-weight: bold; font-size: 16px; cursor: pointer;
            transition: transform 0.2s, opacity 0.2s;
        }
        .btn-gen { background: var(--primary); color: white; }
        .btn-pre { background: var(--secondary); color: white; }
        button:active { transform: scale(0.98); }

        /* çµæœå±•ç¤ºå€åŸŸ */
        .display-box {
            margin-top: 20px; padding-top: 20px; border-top: 2px dashed #eee;
            text-align: center; display: none;
        }
        #typing-text { font-size: 1.3rem; margin: 20px 0; color: #2d3436; min-height: 1.5em; font-weight: 500; }
        #qrcode-container { display: flex; justify-content: center; margin-bottom: 15px; background: white; padding: 10px; }
        
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div id="editor-ui">
        <h2>ğŸµ è£½ä½œéŸ³æ¨‚è¨Šæ¯å¡</h2>
        
        <label>ğŸ’Œ ç•™è¨€å…§å®¹ï¼š</label>
        <input type="text" id="userMsg" placeholder="ä¾‹å¦‚ï¼šé€™é¦–æ­Œè®“æˆ‘æƒ³èµ·ä½ ...">
        
        <label>ğŸ¼ ABC æ¨‚è­œä»£ç¢¼ï¼š</label>
        <textarea id="userAbc" placeholder="è²¼ä¸Š ABC Code..."></textarea>
        
        <div class="btn-group">
            <button class="btn-pre" onclick="preview()">ğŸ‘ï¸ é è¦½æ•ˆæœ</button>
            <button class="btn-gen" onclick="generateQR()">ğŸ“² ç”Ÿæˆ QR</button>
        </div>
    </div>

    <div id="result-ui" class="display-box">
        <div id="typing-text"></div>
        <div id="qrcode-container"></div>
        <button id="playBtn" class="btn-pre" style="width:100%">ğŸ¶ æ’­æ”¾éŸ³æ¨‚è¨Šæ¯</button>
    </div>
</div>

<script>
    // é è¨­ä½ çš„ä¸»æ—‹å¾‹ (è½‰æ›å¾Œçš„æ ¼å¼)
    const defaultABC = "X:1\nM:4/4\nL:1/16\nQ:113\nK:C\n^d z ^d ^c B2 ^c z d2 ^c z d2 | z2 z2 ^c2 ^f z ^f2 ^A, z G,4";
    document.getElementById('userAbc').value = defaultABC;
    document.getElementById('userMsg').value = "é€ä½ ä¸€æ®µå¾©å¤æ—‹å¾‹ï¼";

    // 1. ç”Ÿæˆ QR Code åŠŸèƒ½
    function generateQR() {
        const msg = document.getElementById('userMsg').value;
        const abc = document.getElementById('userAbc').value;
        const baseUrl = window.location.origin + window.location.pathname;
        
        // å°è£æˆæ”œå¸¶åƒæ•¸çš„ç¶²å€
        const finalUrl = `${baseUrl}?t=${encodeURIComponent(msg)}&abc=${encodeURIComponent(abc)}`;
        
        const container = document.getElementById('qrcode-container');
        container.innerHTML = ""; // æ¸…ç©º
        new QRCode(container, { text: finalUrl, width: 200, height: 200 });
        
        document.getElementById('result-ui').style.display = 'block';
        document.getElementById('playBtn').classList.add('hidden'); // ç”Ÿæˆæ™‚ä¸é¡¯ç¤ºæ’­æ”¾éˆ•
        alert("QR Code å·²ç”Ÿæˆï¼Œæƒæå³å¯å‚³é€ï¼");
    }

    // 2. é è¦½èˆ‡æ’­æ”¾åŠŸèƒ½
    async function preview() {
        await Tone.start();
        const msg = document.getElementById('userMsg').value;
        const abc = document.getElementById('userAbc').value;
        
        document.getElementById('result-ui').style.display = 'block';
        document.getElementById('qrcode-container').innerHTML = ""; // é è¦½æ™‚éš±è— QR
        document.getElementById('typing-text').innerText = "";
        
        startShow(msg, abc);
    }

    function startShow(msg, abc) {
        // æ–‡å­—æ‰“å­—æ©Ÿ
        let i = 0;
        const timer = setInterval(() => {
            document.getElementById('typing-text').innerText += msg[i];
            i++;
            if (i >= msg.length) clearInterval(timer);
        }, 100);

        // éŸ³æ¨‚æ’­æ”¾ (æ–¹æ³¢)
        const synth = new Tone.Synth({ oscillator: { type: "square" } }).toDestination();
        const now = Tone.now();
        
        // ç°¡æ˜“éŸ³ç¬¦è§£æé‚è¼¯
        const notes = abc.match(/\^?[A-Ga-g]/g) || [];
        notes.forEach((n, idx) => {
            let toneNote = n.replace('^', '#') + "4";
            synth.triggerAttackRelease(toneNote, "16n", now + idx * 0.15);
        });
    }

    // 3. è‡ªå‹•è¾¨è­˜æ”¶è¨Šæ¨¡å¼
    const params = new URLSearchParams(window.location.search);
    if (params.has('abc')) {
        document.getElementById('editor-ui').classList.add('hidden');
        document.getElementById('result-ui').style.display = 'block';
        document.getElementById('playBtn').onclick = () => {
            document.getElementById('playBtn').classList.add('hidden');
            startShow(decodeURIComponent(params.get('t')), decodeURIComponent(params.get('abc')));
        };
    }
</script>

</body>
</html>
