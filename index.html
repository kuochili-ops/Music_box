<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³æ¨‚è¨Šæ¯ç›’ ğŸµ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; display: flex; justify-content: center; padding: 20px; }
        .container { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 450px; }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
        textarea { font-family: monospace; height: 120px; }
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        button { flex: 1; padding: 14px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 16px; }
        .btn-pre { background: #55efc4; color: #004d40; }
        .btn-gen { background: #6c5ce7; color: white; }
        #result-area { margin-top: 20px; text-align: center; border-top: 2px dashed #eee; padding-top: 20px; }
        #typing-text { font-size: 1.4rem; margin: 20px 0; font-weight: 600; color: #333; min-height: 1.5em; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div id="editor-ui">
        <h2>ğŸµ è£½ä½œéŸ³æ¨‚è¨Šæ¯</h2>
        <div class="input-group">
            <label>ğŸ’¬ ç•™è¨€å…§å®¹ï¼š</label>
            <input type="text" id="userMsg" value="é€™æ®µæ—‹å¾‹å¤ªæ´—è…¦äº†ï¼">
        </div>
        <div class="input-group">
            <label>ğŸ¼ ABC æ¨‚è­œä»£ç¢¼ï¼š</label>
            <textarea id="userAbc"></textarea>
        </div>
        <div class="btn-group">
            <button class="btn-pre" onclick="startLoop()">ğŸ‘ï¸ å¾ªç’°æ’­æ”¾é è¦½</button>
            <button class="btn-gen" onclick="generateQR()">ğŸ“² ç”Ÿæˆ QR</button>
        </div>
    </div>

    <div id="result-area" class="hidden">
        <div id="typing-text"></div>
        <div id="qrcode-container"></div>
    </div>
</div>

<script>
    // é å¡«ä½ æä¾›çš„æ—‹å¾‹
    document.getElementById('userAbc').value = `X:1\nM:4/4\nL:1/4\nQ:1/4=200\nK:C\nE/8-E/8-E/8-E/8-E/8-E/8-E/8-E/8-E/8-E/8-E/8-E/8-E/8-E/8-E/8-E/8-E/8-E/8-E/8-E/8-E/8-E/8-E/8-E/8-E/8-E/8-E/8-E/8-E/8-E/8-E/8-E/8 |\nG G# A2 | G E C2 | <B C D2 | C <A G2. | B >D G2 | A G. A/2 | F E G1`;

    let typingInterval = null;

    async function startLoop() {
        await Tone.start();
        Tone.Transport.stop();
        Tone.Transport.cancel();
        if (typingInterval) clearInterval(typingInterval);
        
        document.getElementById('result-area').classList.remove('hidden');
        const msg = document.getElementById('userMsg').value;
        const abc = document.getElementById('userAbc').value;

        const synth = new Tone.Synth({ 
            oscillator: { type: "square" },
            envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 0.8 }
        }).toDestination();

        // ç°¡å–®è§£æå™¨ï¼šè¨ˆç®—ç¸½æ™‚é•·ä¸¦æ’ç¨‹
        const tokens = abc.match(/(\^?_?[A-Ga-g][,']*\d*\/??\d*|z\d*\/??\d*)/g) || [];
        const secondsPerBeat = 60 / 200; // Q:200
        let totalTime = 0;

        const part = new Tone.Part((time, note) => {
            if (note.pitch) {
                synth.triggerAttackRelease(note.pitch, note.dur, time);
            }
        }, []).start(0);

        tokens.forEach(t => {
            let durMatch = t.match(/(\d*)(\/?)(\d*)$/);
            let multiplier = 1;
            if (durMatch) {
                let num = parseInt(durMatch[1]) || 1;
                let den = parseInt(durMatch[3]) || (durMatch[2] ? 2 : 1);
                multiplier = num / den;
            }

            if (!t.startsWith('z')) {
                let pitch = t.match(/\^?_?[A-Ga-g][,']*/)[0]
                             .replace('^', '#').replace('_', 'b')
                             .replace('c', 'C5').replace('d', 'D5').replace('e', 'E5');
                if (!pitch.match(/\d/)) pitch += "4"; // é è¨­ 4 å…«åº¦
                
                part.add(totalTime * secondsPerBeat, { pitch: pitch, dur: (multiplier * secondsPerBeat * 0.9) + "s" });
            }
            totalTime += multiplier;
        });

        // æ ¸å¿ƒï¼šå¾ªç’°é‚è¼¯
        const loopDuration = totalTime * secondsPerBeat;
        Tone.Transport.scheduleRepeat((time) => {
            Tone.Draw.schedule(() => {
                runTyping(msg);
            }, time);
        }, loopDuration);

        Tone.Transport.start();
    }

    function runTyping(text) {
        if (typingInterval) clearInterval(typingInterval);
        const el = document.getElementById('typing-text');
        el.innerText = "";
        let i = 0;
        typingInterval = setInterval(() => {
            el.innerText += text[i];
            i++;
            if (i >= text.length) clearInterval(typingInterval);
        }, 100);
    }

    function generateQR() {
        const url = `${window.location.origin}${window.location.pathname}?t=${encodeURIComponent(document.getElementById('userMsg').value)}&abc=${encodeURIComponent(document.getElementById('userAbc').value)}`;
        const container = document.getElementById('qrcode-container');
        container.innerHTML = "";
        new QRCode(container, { text: url, width: 180, height: 180 });
        document.getElementById('result-area').classList.remove('hidden');
    }
</script>
</body>
</html>
