<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³æ¨‚è¨Šæ¯ç”¢ç”Ÿå™¨ ğŸµ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; padding: 20px; display: flex; justify-content: center; }
        .container { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 450px; }
        h2 { display: flex; align-items: center; gap: 10px; color: #333; margin-top: 0; }
        label { display: flex; align-items: center; gap: 8px; margin: 15px 0 8px; font-weight: bold; color: #555; }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 16px; background: #fafafa; }
        textarea { font-family: 'Consolas', monospace; height: 120px; line-height: 1.4; }
        .btn-group { display: flex; gap: 12px; margin-top: 20px; }
        button { flex: 1; padding: 14px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .btn-pre { background: #55efc4; color: #004d40; }
        .btn-gen { background: #6c5ce7; color: white; }
        button:active { transform: scale(0.98); }
        #result-area { margin-top: 25px; padding-top: 20px; border-top: 2px dashed #eee; text-align: center; }
        #typing-text { font-size: 1.3rem; margin: 20px 0; color: #2d3436; font-weight: 600; min-height: 1.5em; }
        #qrcode-container { display: inline-block; padding: 10px; background: white; border: 1px solid #eee; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div id="editor-ui">
        <h2>ğŸµ è£½ä½œéŸ³æ¨‚è¨Šæ¯</h2>
        <label>ğŸ’¬ ç•™è¨€å…§å®¹ï¼š</label>
        <input type="text" id="userMsg" value="é€™æ˜¯ä¸€å°éŸ³æ¨‚æƒ…æ›¸ï¼">
        
        <label>ğŸ¼ ABC æ¨‚è­œä»£ç¢¼ï¼š</label>
        <textarea id="userAbc">X:1
M:4/4
L:1/16
Q:113
K:C
^d z ^d ^c B2 ^c z d2 ^c z d2 | z2 z2 ^c2 ^f z ^f2 ^A, z G,4</textarea>
        
        <div class="btn-group">
            <button class="btn-pre" onclick="preview()">ğŸ‘ï¸ é è¦½æ’­æ”¾</button>
            <button class="btn-gen" onclick="generateQR()">ğŸ“² ç”Ÿæˆ QR</button>
        </div>
    </div>

    <div id="result-area" class="hidden">
        <div id="typing-text"></div>
        <div id="qrcode-container"></div>
        <div id="status-msg" style="font-size: 0.8rem; color: #999;"></div>
    </div>
</div>

<script>
    async function preview() {
        await Tone.start();
        const msg = document.getElementById('userMsg').value;
        const abc = document.getElementById('userAbc').value;
        
        document.getElementById('result-area').classList.remove('hidden');
        document.getElementById('typing-text').innerText = "";
        
        typeWriter(msg);
        playAdvancedABC(abc);
    }

    function generateQR() {
        const msg = document.getElementById('userMsg').value;
        const abc = document.getElementById('userAbc').value;
        const finalUrl = `${window.location.origin}${window.location.pathname}?t=${encodeURIComponent(msg)}&abc=${encodeURIComponent(abc)}`;
        
        const container = document.getElementById('qrcode-container');
        container.innerHTML = "";
        new QRCode(container, { text: finalUrl, width: 180, height: 180 });
        document.getElementById('result-area').classList.remove('hidden');
        document.getElementById('status-msg').innerText = "QR Code å·²æ›´æ–°ï¼æƒæå³å¯å‚³é€ã€‚";
    }

    function typeWriter(text) {
        let i = 0;
        const display = document.getElementById('typing-text');
        const timer = setInterval(() => {
            display.innerText += text[i];
            i++;
            if (i >= text.length) clearInterval(timer);
        }, 120);
    }

    // --- é€²éš ABC è§£æå™¨ ---
    function playAdvancedABC(abc) {
        const synth = new Tone.Synth({ 
            oscillator: { type: "square" },
            envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 1 }
        }).toDestination();
        
        const now = Tone.now();
        let currentTime = 0;
        
        // æŠ“å–éŸ³ç¬¦æŒ‡ä»¤ï¼šåŒ…æ‹¬å‡è™Ÿ(^)ã€éŸ³å(A-G, a-g)ã€ä¼‘æ­¢ç¬¦(z)ã€é•·åº¦(æ•¸å­—)
        const tokens = abc.match(/\^?[A-Ga-gz]\d*/g) || [];
        
        tokens.forEach(token => {
            const isRest = token.includes('z');
            const hasSharp = token.includes('^');
            const noteName = token.match(/[A-Ga-g]/)?.[0];
            const durationMatch = token.match(/\d+/);
            const duration = durationMatch ? parseInt(durationMatch[0]) : 1;
            
            if (!isRest && noteName) {
                // åŸºç¤éŸ³é«˜è™•ç†
                let octave = (noteName === noteName.toLowerCase()) ? 5 : 4;
                let pitch = noteName.toUpperCase() + (hasSharp ? "#" : "") + octave;
                
                // æ’­æ”¾éŸ³ç¬¦ï¼š16n * duration
                synth.triggerAttackRelease(pitch, (duration * 0.12) + "s", now + currentTime);
            }
            
            // ç´¯åŠ æ™‚é–“ï¼šä»¥ 16 åˆ†éŸ³ç¬¦ç‚ºåŸºæº– (ç´„ 0.13s)
            currentTime += duration * 0.13;
        });
    }

    // è‡ªå‹•åµæ¸¬æ¨¡å¼
    const params = new URLSearchParams(window.location.search);
    if (params.has('abc')) {
        document.getElementById('userMsg').value = decodeURIComponent(params.get('t'));
        document.getElementById('userAbc').value = decodeURIComponent(params.get('abc'));
        // å¦‚æœæ˜¯æ”¶è¨Šæ¨¡å¼ï¼Œå¯ä»¥è‡ªå‹•è§¸ç™¼é¡¯ç¤º
        document.getElementById('result-area').classList.remove('hidden');
    }
</script>

</body>
</html>
