<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³æ¨‚è¨Šæ¯ QR Code ç”¢ç”Ÿå™¨ ğŸµ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #f4f7f6; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 90%; max-width: 400px; text-align: center; }
        h1 { color: #333; font-size: 1.5rem; }
        label { display: block; text-align: left; margin: 10px 0 5px; font-weight: bold; }
        input, textarea { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: #6c5ce7; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; }
        button:hover { background: #5b4cc4; }
        #qrcode { margin-top: 20px; display: flex; justify-content: center; }
        .hidden { display: none; }
        #message-display { font-size: 1.2rem; margin-bottom: 20px; color: #2d3436; min-height: 1.5em; }
    </style>
</head>
<body>

    <div id="generator-ui" class="card">
        <h1>è£½ä½œéŸ³æ¨‚å¡ç‰‡ ğŸ</h1>
        <label>1. è¼¸å…¥è¨Šæ¯ï¼š</label>
        <input type="text" id="userMsg" placeholder="ä¾‹å¦‚ï¼šé€™é¦–æ­Œé€çµ¦ä½ ï¼">
        
        <label>2. è²¼ä¸Š ABC æ¨‚è­œï¼š</label>
        <textarea id="userAbc" rows="5" placeholder="è²¼ä¸Šè½‰å¥½çš„ ABC ä»£ç¢¼..."></textarea>
        
        <button onclick="generateQR()">ç”Ÿæˆ QR Code</button>
        <div id="qrcode"></div>
    </div>

    <div id="player-ui" class="card hidden">
        <div id="message-display"></div>
        <button id="startBtn" onclick="startExperience()">ğŸ¶ é–‹å•Ÿé©šå–œ</button>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);

        // åˆå§‹åŒ–ï¼šåˆ¤æ–·æ˜¯ã€Œè£½ä½œæ¨¡å¼ã€é‚„æ˜¯ã€Œæ”¶è¨Šæ¨¡å¼ã€
        window.onload = () => {
            if (urlParams.has('abc')) {
                document.getElementById('generator-ui').classList.add('hidden');
                document.getElementById('player-ui').classList.remove('hidden');
            }
        };

        // --- åŠŸèƒ½ï¼šç”Ÿæˆ QR Code ---
        function generateQR() {
            const msg = document.getElementById('userMsg').value;
            const abc = document.getElementById('userAbc').value;
            const baseUrl = window.location.href.split('?')[0];
            
            // å°‡å…§å®¹ç·¨ç¢¼é€²ç¶²å€
            const finalUrl = `${baseUrl}?t=${encodeURIComponent(msg)}&abc=${encodeURIComponent(abc)}`;
            
            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = ""; // æ¸…é™¤èˆŠçš„
            new QRCode(qrContainer, {
                text: finalUrl,
                width: 200,
                height: 200
            });
        }

        // --- åŠŸèƒ½ï¼šæ’­æ”¾éŸ³æ¨‚èˆ‡æ–‡å­— ---
        async function startExperience() {
            await Tone.start();
            document.getElementById('startBtn').classList.add('hidden');

            const msg = decodeURIComponent(urlParams.get('t') || "");
            const abc = decodeURIComponent(urlParams.get('abc') || "");

            // 1. æ–‡å­—æ‰“å­—æ©Ÿæ•ˆæœ
            typeWriter(msg);

            // 2. æ’­æ”¾æ–¹æ³¢éŸ³æ•ˆ (ä½ è¦æ±‚çš„å¾©å¤éŸ³è‰²)
            const synth = new Tone.Synth({ oscillator: { type: "square" } }).toDestination();
            playAbc(abc, synth);
        }

        function typeWriter(text) {
            let i = 0;
            const display = document.getElementById('message-display');
            const interval = setInterval(() => {
                display.innerText += text[i];
                i++;
                if (i >= text.length) clearInterval(interval);
            }, 100);
        }

        // ç°¡æ˜“ ABC æ’­æ”¾é‚è¼¯ (å¯æ ¹æ“šéœ€æ±‚æ“´å……)
        function playAbc(abc, synth) {
            const now = Tone.now();
            // é€™è£¡ç°¡å–®è§£æéŸ³ç¬¦ï¼Œå¯¦éš›è¤‡é›œæ¨‚è­œéœ€é…åˆæ›´å®Œæ•´çš„è§£æå™¨
            const notes = abc.replace(/\s/g, "").split(""); 
            notes.forEach((n, index) => {
                if (n.match(/[A-Ga-g]/)) {
                    synth.triggerAttackRelease(n + "4", "8n", now + index * 0.2);
                }
            });
        }
    </script>
</body>
</html>
