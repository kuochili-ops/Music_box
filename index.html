<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³æ¨‚è¨Šæ¯ç›’å­ ğŸµ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: #333;
        }

        .card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            width: 380px; /* ç¨å¾®åŠ å¤§å¡ç‰‡å¯¬åº¦ä»¥å®¹ç´å…§å®¹ */
            text-align: center;
            transition: background-color 0.5s ease;
        }

        h1 { color: #333; font-size: 1.8rem; margin-bottom: 20px; }
        label { display: block; text-align: left; margin-top: 15px; margin-bottom: 5px; font-weight: bold; color: #555; }
        input[type="text"], textarea {
            width: calc(100% - 24px); /* èª¿æ•´å¯¬åº¦ä»¥è€ƒæ…® padding */
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            box-sizing: border-box;
            font-size: 1rem;
        }
        textarea {
            resize: vertical; /* å…è¨±å‚ç›´èª¿æ•´å¤§å° */
            min-height: 80px;
            font-family: 'Consolas', 'Courier New', monospace; /* æ¨‚è­œä»£ç¢¼ä½¿ç”¨ç­‰å¯¬å­—é«” */
        }

        button {
            width: 100%;
            padding: 14px;
            margin-top: 20px;
            border-radius: 8px;
            border: none;
            background-color: #6c5ce7;
            color: white;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1rem;
            transition: background-color 0.3s ease;
        }

        button:hover { background-color: #5b4cc4; }

        #qrcode {
            margin-top: 30px;
            display: flex;
            justify-content: center;
        }

        #typing-text {
            font-size: 1.4rem;
            min-height: 2em; /* ç¢ºä¿æœ‰è¶³å¤ çš„ç©ºé–“é¡¯ç¤ºæ–‡å­— */
            color: #555;
            margin-bottom: 30px;
            white-space: pre-wrap; /* ä¿ç•™æ›è¡Œ */
            line-height: 1.6;
        }
        
        #player-ui button {
            background-color: #28a745; /* æ’­æ”¾æŒ‰éˆ•ä½¿ç”¨ç¶ è‰² */
        }
        #player-ui button:hover {
            background-color: #218838;
        }

        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="generator-ui" class="card hidden">
        <h1>ğŸµ è£½ä½œéŸ³æ¨‚ QR Code</h1>
        <label for="userMsg">ä½ çš„è¨Šæ¯ï¼š</label>
        <input type="text" id="userMsg" placeholder="å°æ”¶è¨Šè€…èªªçš„è©± (ä¾‹å¦‚: ç”Ÿæ—¥å¿«æ¨‚!)">
        
        <label for="userAbc">ABC æ¨‚è­œä»£ç¢¼ï¼š</label>
        <textarea id="userAbc" placeholder="è²¼ä¸Šä½ çš„ ABC æ¨‚è­œä»£ç¢¼ (ä¾‹å¦‚: CDEF)" rows="6"></textarea>
        
        <button onclick="generateQR()">ç”Ÿæˆ QR Code</button>
        <div id="qrcode"></div>
    </div>

    <div id="player-ui" class="card hidden">
        <div id="typing-text"></div>
        <button id="playBtn" onclick="startExperience()">ğŸ¶ é–‹å•ŸéŸ³æ¨‚è¨Šæ¯</button>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        let currentSynth = null; // ç”¨æ–¼å„²å­˜ç•¶å‰æ­£åœ¨æ’­æ”¾çš„ Tone.js åˆæˆå™¨

        // é é¢è¼‰å…¥æ™‚åˆ¤æ–·æ¨¡å¼
        window.onload = function() {
            if (urlParams.has("abc")) {
                document.getElementById("player-ui").classList.remove("hidden");
            } else {
                document.getElementById("generator-ui").classList.remove("hidden");
                // é å¡«å…¥ä½ çš„ MML è½‰æ›å¾Œçš„ ABC ä»£ç¢¼
                document.getElementById("userAbc").value = `X:1
T:Retro Tune
M:4/4
L:1/16
Q:1/4=113
K:C treble
^D5 z ^D5 ^C5 B4 z ^C5 ^D5 z ^C5 ^D5 z ^C5 z ^F5 z ^F5 ^A,4 ^G,4 |
^G5 z ^A5 z ^G5 z ^F5 z ^G5 z ^A5 z ^G5 z ^F5 z ^D5 z ^D5 ^C5 ^D5 z |
^F5 z ^G5 z ^F5 z ^G5 z ^F5 z ^G5 z ^F5 z ^D5 z ^C5 z ^D5 z ^F5 z |
^D5 z ^D5 ^C5 B4 z ^C5 ^D5 z ^C5 ^D5 z ^C5 z ^F5 z ^F5 ^A,4 ^G,4 |
^G5 z ^A5 z ^G5 z ^F5 z ^G5 z ^A5 z ^G5 z ^F5 z ^D5 z ^D5 ^C5 ^D5 z |
^F5 z ^G5 z ^F5 z ^G5 z ^F5 z ^G5 z ^F5 z ^D5 z ^C5 z ^D5 z ^F5 z |`;
            }
        };

        // --- ç”¢ç”Ÿå™¨æ¨¡å¼ ---
        function generateQR() {
            const baseUrl = window.location.href.split('?')[0]; // å–å¾—ç•¶å‰ç¶²å€
            const abcCode = document.getElementById("userAbc").value;
            const message = document.getElementById("userMsg").value;

            // ä½¿ç”¨ encodeURIComponent ç¢ºä¿æ‰€æœ‰ç‰¹æ®Šå­—å…ƒéƒ½èƒ½å®‰å…¨åœ°æ”¾å…¥ç¶²å€
            const finalUrl = `${baseUrl}?abc=${encodeURIComponent(abcCode)}&t=${encodeURIComponent(message)}`;
            
            // æ¸…ç©ºèˆŠçš„ QR Code ä¸¦ç”Ÿæˆæ–°çš„
            document.getElementById("qrcode").innerHTML = "";
            new QRCode(document.getElementById("qrcode"), {
                text: finalUrl,
                width: 200, // ç¨å¾®åŠ å¤§ QR Code å°ºå¯¸
                height: 200,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
            alert("QR Code å·²ç”Ÿæˆï¼æƒæå³å¯é è¦½é›»å­å¡ç‰‡ã€‚");
        }

        // --- æ’­æ”¾å™¨æ¨¡å¼ ---
        async function startExperience() {
            await Tone.start(); // å•Ÿå‹• Tone.js
            document.getElementById("playBtn").classList.add("hidden"); // éš±è—æ’­æ”¾æŒ‰éˆ•

            const rawAbc = urlParams.get("abc");
            const abcCode = rawAbc ? decodeURIComponent(rawAbc) : "M:4/4\nL:1/8\nCDEF|GABc"; // é è¨­ä¸€æ®µç°¡çŸ­çš„ ABC
            const message = urlParams.has("t") ? decodeURIComponent(urlParams.get("t")) : "é€™æ˜¯ä¸€å€‹éŸ³æ¨‚è¨Šæ¯ï¼";
            
            typeWriter(message, 0); // å•Ÿå‹•æ‰“å­—æ©Ÿæ•ˆæœ
            playABC(abcCode); // æ’­æ”¾éŸ³æ¨‚
        }

        // æ‰“å­—æ©Ÿæ•ˆæœå‡½å¼
        function typeWriter(text, i) {
            if (i < text.length) {
                document.getElementById("typing-text").innerHTML += text.charAt(i);
                setTimeout(() => typeWriter(text, i + 1), 70); // èª¿æ•´æ‰“å­—é€Ÿåº¦ (æ¯«ç§’)
            }
        }

        // æ’­æ”¾ ABC æ¨‚è­œçš„å‡½å¼
        function playABC(abcCode) {
            // è§£æ ABC æ¨™é ­ç²å–ç¯€æ‹ (Q:) å’ŒåŸºæº–éŸ³é•· (L:)
            let bpm = 120; // é è¨­ BPM
            let defaultNoteLength = 0.25; // é è¨­ 1/4 éŸ³ç¬¦

            const headerLines = abcCode.split('\n');
            headerLines.forEach(line => {
                if (line.startsWith('Q:')) {
                    const qValue = line.substring(2);
                    const match = qValue.match(/(\d+\/\d+)=(\d+)/);
                    if (match && match[2]) {
                        bpm = parseInt(match[2]);
                    } else if (!isNaN(parseInt(qValue))) {
                         bpm = parseInt(qValue); // å¦‚æœåªæ˜¯ Q:120 é€™ç¨®æ ¼å¼
                    }
                }
                if (line.startsWith('L:')) {
                    const lValue = line.substring(2);
                    if (lValue === '1/16') defaultNoteLength = 0.125;
                    else if (lValue === '1/8') defaultNoteLength = 0.25;
                    else if (lValue === '1/4') defaultNoteLength = 0.5;
                }
            });
            Tone.Transport.bpm.value = bpm; // è¨­å®šå…¨å±€ BPM

            currentSynth = new Tone.Synth({
                oscillator: { type: "square" }, // æ–¹æ³¢éŸ³è‰²
                envelope: {
                    attack: 0.01,
                    decay: 0.2,
                    sustain: 0.05,
                    release: 0.5
                }
            }).toDestination();

            const notes = parseAbcToToneNotes(abcCode, defaultNoteLength);
            
            // ä½¿ç”¨ Tone.Part ä¾†æ›´ç²¾ç¢ºåœ°å®‰æ’éŸ³ç¬¦
            const part = new Tone.Part((time, value) => {
                currentSynth.triggerAttackRelease(value.pitch, value.duration, time);
            }, notes).start(0);

            Tone.Transport.loop = true; // è®“éŸ³æ¨‚å¾ªç’°æ’­æ”¾
            Tone.Transport.loopEnd = notes.length > 0 ? notes[notes.length - 1].time + 1 : "4m"; // å¾ªç’°çµæŸé»
            Tone.Transport.start();
        }

        // --- ABC è½‰æ› Tone.js éŸ³ç¬¦é‚è¼¯ ---
        function parseAbcToToneNotes(abcCode, defaultNoteLength) {
            const toneNotes = [];
            let currentTime = 0; // è¿½è¹¤ç•¶å‰æ™‚é–“é»
            let currentOctave = 4; // é è¨­å…«åº¦
            let currentBaseNoteLength = defaultNoteLength; // å¾ L: è¨­å®š

            const noteMap = { 'C': 0, 'D': 2, 'E': 4, 'F': 5, 'G': 7, 'A': 9, 'B': 11 };
            const abcLines = abcCode.split('\n');
            
            abcLines.forEach(line => {
                // è·³éæ¨™é ­å’Œç©ºè¡Œ
                if (line.startsWith('X:') || line.startsWith('T:') || line.startsWith('M:') ||
                    line.startsWith('L:') || line.startsWith('Q:') || line.startsWith('K:') ||
                    line.trim() === '') {
                    return;
                }

                for (let i = 0; i < line.length; i++) {
                    let char = line[i];
                    let accidental = 0; // å‡é™è¨˜è™Ÿ: -1 é™, 1 å‡, 0 è‡ªç„¶
                    let noteValue = -1; // éŸ³é«˜å€¼ (0=C, 1=C#, ...)
                    let durationMultiplier = 1; // éŸ³é•·å€æ•¸

                    // è™•ç†å‡é™è¨˜è™Ÿ
                    if (char === '^') { accidental = 1; char = line[++i]; } // å‡è™Ÿ
                    else if (char === '_') { accidental = -1; char = line[++i]; } // é™è™Ÿ
                    else if (char === '=') { accidental = 0; char = line[++i]; } // é‚„åŸ

                    // è™•ç†éŸ³ç¬¦æˆ–ä¼‘æ­¢ç¬¦
                    if (noteMap[char.toUpperCase()] !== undefined) {
                        noteValue = noteMap[char.toUpperCase()];
                        if (char.toLowerCase() === char) { // å°å¯«å­—æ¯è¡¨ç¤ºé«˜å…«åº¦
                            currentOctave = 5; 
                        } else { // å¤§å¯«å­—æ¯è¡¨ç¤ºä½å…«åº¦
                            currentOctave = 4;
                        }
                    } else if (char === 'z') { // ä¼‘æ­¢ç¬¦
                        noteValue = -2; // ç‰¹æ®Šæ¨™è¨˜ç‚ºä¼‘æ­¢ç¬¦
                    } else if (char === '<') { // èˆŠç‰ˆ ABC å¯èƒ½ç”¨ < >
                         currentOctave--; continue; // é™å…«åº¦
                    } else if (char === '>') {
                         currentOctave++; continue; // å‡å…«åº¦
                    }

                    // è™•ç†éŸ³é•·
                    let numStr = "";
                    while (i + 1 < line.length && !isNaN(parseInt(line[i+1]))) {
                        numStr += line[++i];
                    }
                    if (numStr !== "") durationMultiplier = parseInt(numStr);
                    if (line[i+1] === '/') { // è™•ç†åˆ†æ•¸éŸ³ç¬¦ (å¦‚ C/2, C//2)
                        i++;
                        let divisorStr = "";
                        while (i + 1 < line.length && !isNaN(parseInt(line[i+1]))) {
                            divisorStr += line[++i];
                        }
                        let divisor = divisorStr !== "" ? parseInt(divisorStr) : 2;
                        durationMultiplier = durationMultiplier / divisor;
                    }

                    // å°‡éŸ³é«˜è½‰æ›ç‚º Tone.js æ ¼å¼
                    if (noteValue !== -1 && noteValue !== -2) {
                        let finalPitch = Tone.Midi(noteValue + accidental + (currentOctave * 12)).toNote();
                        toneNotes.push({
                            time: currentTime,
                            pitch: finalPitch,
                            duration: currentBaseNoteLength * durationMultiplier
                        });
                    }

                    // è¨ˆç®—ä¸‹ä¸€å€‹éŸ³ç¬¦çš„æ™‚é–“é»
                    currentTime += currentBaseNoteLength * durationMultiplier;
                }
            });
            return toneNotes;
        }
    </script>
</body>
</html>
