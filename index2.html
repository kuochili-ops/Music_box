<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¦¬å¹´æ©«å¼è³€å¡ ğŸğŸµ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <style>
        :root { 
            --primary: #6c5ce7; 
            --bg: #f1f2f6; 
            --soft-red: #ffe3e3; 
            --flip-duration: 2.2s; 
            /* æ©«å¼å°ºå¯¸ 3:2 æ¯”ä¾‹ */
            --card-width: 500px; 
            --card-height: 350px;
            --neon-green: #39FF14;
        }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; perspective: 2000px; overflow: hidden; }
        
        /* å¡ç‰‡å®¹å™¨ï¼šç¿»é–‹æ™‚å‘ä¸‹ç§»å‹•ä¸€åŠçš„é«˜åº¦ï¼Œä¿æŒåœ¨ç•«é¢ä¸­å¤® */
        #card-container { width: var(--card-width); height: var(--card-height); position: relative; transform-style: preserve-3d; transition: transform var(--flip-duration) cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; }
        #card-container.is-open { transform: translateY(175px); }

        /* å°é¢å±¤ï¼šè»¸å¿ƒæ”¹ç‚ºé ‚éƒ¨ (Top) */
        #card-flap { position: absolute; width: 100%; height: 100%; top: 0; left: 0; transform-style: preserve-3d; transform-origin: top; transition: transform var(--flip-duration) cubic-bezier(0.4, 0, 0.2, 1); z-index: 100; }
        .hint-animation { animation: flap-hint 3s ease-in-out infinite; }
        @keyframes flap-hint { 0%, 100% { transform: rotateX(0deg); } 50% { transform: rotateX(-10deg); } }

        /* å‘ä¸Šç¿»è½‰ 180 åº¦ */
        #card-container.is-open #card-flap { transform: rotateX(180deg); }
        
        /* å°é¢åœ–ç‰‡ IMG_6829.png */
        #card-cover { position: absolute; width: 100%; height: 100%; background-image: url('IMG_6829.png'); background-size: cover; background-position: center; border-radius: 15px 15px 0 0; backface-visibility: hidden; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        #card-cover.no-img { background: #d63031; display:flex; align-items:center; justify-content:center; color:gold; font-size:24px; font-weight:bold;}

        /* ä¸Šå…§é  (ç¿»é–‹å¾Œå°é¢çš„å…§å´) */
        #card-top-inner { position: absolute; width: 100%; height: 100%; background-color: #fff; border-radius: 15px 15px 0 0; transform: rotateX(180deg); backface-visibility: hidden; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        #card-top-inner img { width: 100%; height: 100%; object-fit: cover; }

        /* ä¸‹å…§é  (åº•å±¤ä¸»å…§å®¹å€) IMG_6830.png */
        #card-bottom-inner { position: absolute; width: 100%; height: 100%; top: 0; left: 0; background: white; background-image: url('IMG_6830.png'); background-size: cover; border-radius: 0 0 15px 15px; display: flex; flex-direction: column; align-items: center; padding: 20px; box-sizing: border-box; z-index: 10; clip-path: inset(100% 0 0 0); transition: clip-path 1.8s cubic-bezier(0.19, 1, 0.22, 1); }
        #card-container.is-open #card-bottom-inner { clip-path: inset(0 0 0 0); }
        
        /* è¢å…‰ç­‰åŒ–å™¨ */
        #music-visualizer { 
            display: flex; justify-content: center; align-items: flex-end; 
            width: 80%; height: 60px; background: #000; 
            border-radius: 8px; margin-top: 20px; padding: 10px; box-sizing: border-box; gap: 3px;
        }
        .bar { flex: 1; background: var(--neon-green); border-radius: 1px 1px 0 0; height: 5%; will-change: height; box-shadow: 0 0 5px var(--neon-green); }
        
        #youtube-player-container { position: absolute; width: 1px; height: 1px; opacity: 0; pointer-events: none; top: -1000px; }

        /* æ‰“å­—æ–‡å­—èˆ‡ UI */
        #typing-text { font-size: 1.2rem; font-weight: 700; color: #2d3436; text-align: center; min-height: 3em; margin: 15px 0; line-height: 1.4; text-shadow: 0 0 10px rgba(255,255,255,0.8); }
        .editor-box { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 90%; max-width: 420px; margin: 20px; z-index: 500; text-align: center; }
        button { width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; background: var(--primary); color: white; margin-top: 8px; transition: 0.2s; }
        
        .hidden { display: none !important; }

        /* æ‰‹æ©Ÿé©æ‡‰ */
        @media (max-width: 600px) {
            :root { --card-width: 90vw; --card-height: 60vw; }
            #card-container.is-open { transform: translateY(30vw); }
        }
    </style>
</head>
<body>

<div id="editor-ui" class="editor-box">
    <h3>ğŸ é¦¬å¹´æ©«å¼è³€å¡ç·¨è¼¯å™¨</h3>
    <input type="text" id="userMsg" value="è¬é¦¬å¥”é¨°ï¼Œæ–°æ˜¥å¤§å‰ï¼" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:10px; margin-bottom:10px;">
    <button onclick="generatePureUrl()">ğŸ”— è¤‡è£½åˆ†äº«é€£çµ</button>
    <button style="background:#b2bec3;" onclick="previewCard()">ğŸ‘€ é è¦½å¡ç‰‡</button>
</div>

<div id="card-container" class="hidden" onclick="unlockAudioAndOpen()">
    <div id="card-flap" class="hint-animation">
        <div id="card-cover"></div> 
        <div id="card-top-inner">
            <p style="color:#666; font-size: 14px;">Happy New Year</p>
        </div>
    </div>
    <div id="card-bottom-inner">
        <div id="music-visualizer">
            <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
            <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
            <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
            <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
        </div>
        <div id="typing-text"></div>
        <div id="qrcode-container"></div>
    </div>
</div>

<div id="youtube-player-container"><div id="yt-player"></div></div>

<script>
    let player, isPlayerReady = false;
    const PLAYLIST_ID = 'PL1U2BLQmiBscIDy9QQvCmAF-rKjhafMuM'; 

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('yt-player', {
            height: '200', width: '200',
            playerVars: { 'listType': 'playlist', 'list': PLAYLIST_ID, 'autoplay': 0, 'controls': 0, 'loop': 1, 'playsinline': 1 },
            events: { 'onReady': (e) => { isPlayerReady = true; player.setShuffle(true); } }
        });
    }

    const tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    document.head.appendChild(tag);

    // ç‰©ç†è¦–è¦ºåŒ–
    let visualizerInterval = null;
    const bars = document.querySelectorAll('.bar');
    let currentHeights = new Array(bars.length).fill(5);

    function startPhysicsVisualizer() {
        visualizerInterval = setInterval(() => {
            bars.forEach((bar, i) => {
                if (Math.random() < 0.2) currentHeights[i] = Math.random() * 80 + 10;
                currentHeights[i] -= 5;
                if (currentHeights[i] < 5) currentHeights[i] = 5;
                bar.style.height = `${currentHeights[i]}%`;
            });
        }, 50);
    }

    function unlockAudioAndOpen() {
        const container = document.getElementById('card-container');
        if (!container.classList.contains('is-open')) {
            if (isPlayerReady) { player.playVideo(); player.unMute(); player.setVolume(70); startPhysicsVisualizer(); }
            document.getElementById('card-flap').classList.remove('hint-animation');
            container.classList.add('is-open');
            
            const msg = document.getElementById('typing-text').dataset.fullText || document.getElementById('userMsg').value;
            const textEl = document.getElementById('typing-text');
            textEl.innerText = ""; let i = 0;
            setTimeout(() => {
                const timer = setInterval(() => {
                    if (i < msg.length) { textEl.innerText += msg[i]; i++; } else clearInterval(timer);
                }, 150);
            }, 1500);
        }
    }

    window.onload = () => {
        // å°é¢åœ–ç‰‡æª¢æŸ¥ (IMG_6829.png)
        const cover = document.getElementById('card-cover');
        const imgCheck = new Image();
        imgCheck.src = 'IMG_6829.png';
        imgCheck.onerror = () => cover.classList.add('no-img');

        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('v')) {
            document.getElementById('editor-ui').classList.add('hidden');
            document.getElementById('card-container').classList.remove('hidden');
            document.getElementById('typing-text').dataset.fullText = decodeURIComponent(urlParams.get('t') || "");
            new QRCode(document.getElementById('qrcode-container'), { text: window.location.href, width: 60, height: 60 });
        }
    };

    function previewCard() {
        document.getElementById('editor-ui').classList.add('hidden');
        document.getElementById('card-container').classList.remove('hidden');
    }

    function generatePureUrl() {
        const url = `${window.location.origin}${window.location.pathname}?v=6&t=${encodeURIComponent(document.getElementById('userMsg').value)}`;
        navigator.clipboard.writeText(url).then(() => alert("âœ… åˆ†äº«é€£çµå·²è¤‡è£½ï¼"));
    }
</script>
</body>
</html>
